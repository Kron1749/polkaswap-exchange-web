@Library('jenkins-library@SNE-261-arachni')

String agentLabel             = 'docker-build-agent'
String registry               = 'docker.soramitsu.co.jp'
String dockerBuildToolsUserId = 'bot-build-tools-ro'
String envImageName           = 'docker.soramitsu.co.jp/build-tools/node:14-ubuntu-extended'
String targetEnvironment      =  getEnvFromJobName()
String jobList                = 'exchange-' + targetEnvironment
String arachniURL             = 'https://test.polkaswap.io'
String arachniExclude         = 'js|css'
String arachniPlugin          = ''

properties([
    pipelineTriggers([upstream( jobList )])
])

pipeline {
    options {
        buildDiscarder(logRotator(numToKeepStr: '20'))
        timestamps()
        disableConcurrentBuilds()
    }
    agent {
        label agentLabel
    }
    stages {
        stage('Arachni scan') {
            steps{
                script {
                        docker.withRegistry('https://' + registry, dockerBuildToolsUserId) {
                            arachni(arachniURL, arachniExclude, arachniPlugin)
                        }
                    }

            }
        }
    }
    post {
        cleanup { cleanWs() }
    }
}