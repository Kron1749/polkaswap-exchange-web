@Library('jenkins-library@SNE-261-arachni')

String agentLabel             = 'docker-build-agent'
String registry               = 'docker.soramitsu.co.jp'
String dockerBuildToolsUserId = 'bot-build-tools-ro'
String environments             = 'deploy/exchange-dev, deploy/exchange-stage1'
String targetEnvironment      = environments
String jobList                = targetEnvironment
String arachniURL             = targetEnvironment == 'exchange-stage1' ? 'https://test.polkaswap.io' : 'https://exchange.dev.sora2.tachi.soramitsu.co.jp/'
String arachniExclude         = 'js|css'
String arachniPlugin          = ''

properties([
    pipelineTriggers([upstream( jobList )])
])

pipeline {
    options {
        buildDiscarder(logRotator(numToKeepStr: '20'))
        timestamps()
        disableConcurrentBuilds()
    }
    agent {
        label agentLabel
    }
    stages {
        stage('Arachni scan') {
            steps{
                script {
                        docker.withRegistry('https://' + registry, dockerBuildToolsUserId) {
                            arachni(arachniURL, arachniExclude, arachniPlugin)
                        }
                    }

            }
        }
    }
    post {
        cleanup { cleanWs() }
    }
}